var layer ;
var addBut = function () {
    var button = $(".mobile-bd .pre-menu-item").not(".add-item");
    if (button.length < 3) {
        var html = '<li class="pre-menu-item" >';
        html += '<a class="pre-menu-link" onclick="selectedMenu(this)"><input type="hidden" name="menu[' + button.length + '][name]"  class="name" value="菜单名称"><span class="first-menu">';
        html += '<input type="hidden" name="menu[' + button.length + '][type]"  class="type" value="view"><input type="hidden" name="menu[' + button.length + '][url]"  class="url" value="">';
        html += '<input type="hidden" name="menu[' + button.length + '][media_id]"  class="media_id" value=""> <input type="hidden" class="ipt" value=""><input type="hidden" class="ipc" value="">';
        html += '<input type="hidden" name="menu[' + button.length + '][key]"  class="key" value=""></span><i class="icon-menu-dot"></i><span class="vname">菜单名称</span>';
        html += '</a> <div class="sub-pre-menu-box"><ul class="sub-pre-menu-list sub-designer-y" data-id="' + button.length + '">';
        html += '<li class="sub-js-not-sortable add-subitem" onclick="addSubBut(this)"><i class="fa fa-plus"></i></li></ul></div></li>';
        $(html).insertBefore(".add-item");
        if ($(".mobile-bd .pre-menu-item").not(".add-item").length == 3)
            $(".add-item").remove();
    } else {
        $(".add-item").remove();
    }
}

var addSubBut = function (obj) {
    var button = $(".sub-item", $(obj).parent()).not(".add-subitem");
    var pid = $(obj).parent().attr('data-id');
    if (button.length < 5) {
        var html = '<li class="sub-item" onclick="selectedSubMenu(this)"><input type="hidden" name="menu[' + pid + '][sub_button][name][]" class="name" value="添加菜单">';
        html += '<input type="hidden" class="type" name="menu[' + pid + '][sub_button][type][]" value="view"><input type="hidden" name="menu[' + pid + '][sub_button][url][]" class="url" value="">';
        html += '<input type="hidden" class="media_id" name="menu[' + pid + '][sub_button][media_id][]" value=""><input type="hidden" class="key" name="menu[' + pid + '][sub_button][key][]" value="">';
        html += '<input type="hidden" class="ipt" value=""><input type="hidden" class="ipc" value=""><span class="sub-pre-menu-inner"><span class="vname">添加菜单</span></span></li>';
        $(html).insertBefore(obj);
        if ($(".sub-item", $(obj).parent()).not(".add-subitem").length == 5)
            $(obj).remove();
    } else {
        $(obj).remove();
    }
}
var selectedItem;
var selectedMenu = function (obj) {
    $(".menu-form-area").show();
    selectedItem = $(obj);
    $(".active").removeClass("active");
    selectedItem.parent().addClass("active");
    $(".menu-name").val($('.name', selectedItem).val());
    $(".menu-name").focus();
    var ipt = $('.ipt', selectedItem).val();
    var ipc = $('.ipc', selectedItem).val();
    if (ipt === '')
        ipt = 1;
    $("#radio-" + ipt).trigger('click');
    if ($(".sub-item", selectedItem.parent()).length > 0) {
        $(".nosub").hide();
    } else {
        $(".nosub").show();
        switch (ipt)
        {
            case "1":
                var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + ipc + '</div>';
                $('.tw_preview').html(div).show();
                $('.kw_preview').hide();
                $('.preview').hide();
                $(".url-input").val('');
                break;
            case '2':
                var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + ipc + '</div>';
                $('.tw_preview').hide();
                $('.kw_preview').html(div).show();
                $('.preview').hide();
                $(".url-input").val('');
                break;
            case '3':
                $('.preview img').attr('src', ipc);
                $('.kw_preview').hide();
                $('.tw_preview').hide();
                $('.preview').show();
                $(".url-input").val('');
                break;
            case '4':
                $('.kw_preview').hide();
                $('.tw_preview').hide();
                $('.preview').hide();
                $(".url-input").val($('.url', selectedItem).val());
                break;
            case '5':
                var sel = $(".url",selectedItem).val();
                $('.kw_preview').hide();
                $('.tw_preview').hide();
                $('.preview').hide();
                $(".url-input").val('');
                $(".q-button").removeClass('active');
                sel = sel.substr(baseUrl.length)
                $("[data-url='"+ sel +"']").addClass("active");
                break;
            default:
                $('.tw_preview').hide();
                $('.kw_preview').hide();
                break;
        }
    }
}
var selectedSubMenu = function (obj) {
    $(".menu-form-area").show();
    selectedItem = $(obj);
    $(".active").removeClass("active");
    selectedItem.addClass("active");
    $(".menu-name").val($('.name', selectedItem).val());
    $(".menu-name").focus();
    $(".nosub").show();
    var ipt = $('.ipt', selectedItem).val();
    var ipc = $('.ipc', selectedItem).val();
    if (ipt === '')
        $("#radio-1").trigger('click');
    $("#radio-" + ipt).trigger('click');
    switch (ipt)
    {
        case '1':
            var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + ipc + '</div>';
            $('.tw_preview').html(div).show();
            $('.kw_preview').hide();
            $('.preview').hide();
            $(".url-input").val('');
            break;
        case '2':
            var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + ipc + '</div>';
            $('.kw_preview').html(div).show();
            $('.tw_preview').hide();
            $('.preview').hide();
            $(".url-input").val('');
            break;
        case "3":
            $('.preview img').attr('src', ipc);
            $('.kw_preview').hide();
            $('.tw_preview').hide();
            $('.preview').show();
            $(".url-input").val('');
            break;
        case "4":
            $(".url-input").val($('.url', selectedItem).val());
            $('.kw_preview').hide();
            $('.tw_preview').hide();
            $('.preview').hide();
            break;
        case '5':
          var sel = $(".url",selectedItem).val();
          $('.kw_preview').hide();
          $('.tw_preview').hide();
          $('.preview').hide();
          $(".url-input").val('');
          $(".q-button").removeClass('active');
          sel = sel.substr(baseUrl.length)
          $("[data-url='"+ sel +"']").addClass("active");
          break;
        default:
            $('.tw_preview').hide();
            $('.kw_preview').hide();
            $('.preview').hide();
            $(".url-input").val('');
            break;
    }
}
var deleteMenu = function () {
    layer.msg('确认要删除吗？', {
        icon: 2,
        time: 10000, //10s后自动关闭
        shade: [0.2, '#222'],
        btn: ['确认', '取消'],
        yes: function (index ) {
            layer.close(index);
            if (selectedItem.find(".first-menu").length === 1) {
                if( $(".sub-item", selectedItem.parent()).length > 0 ){ 
                    layer.msg('请先删除子菜单!', {icon: 5});
                    return false;
                }
                selectedItem.parent().remove();
                if ($(".add-item").length === 0) {
                    var html = '<li class="pre-menu-item grid-item add-item" ><a onclick="addBut();" class="pre-menu-link">';
                    html += '<i class="icon14-menu-add"></i><span class="">添加菜单</span></a></a></li>';
                    $(".pre-menu-list").append(html);
                }
            } else {
                if ($(".add-subitem", selectedItem.parent()).length === 0) {
                    var html = '<li class="sub-js-not-sortable add-subitem" onclick="addSubBut(this)"><i class="fa fa-plus"></i></li>';
                    selectedItem.parent().append(html);
                }
                selectedItem.remove();
            }
            $(".menu-form-area").hide();
        }
    });
}
var setting = function (obj) {
    $(".vname", selectedItem).html($(obj).val());
    $('.name', selectedItem).val($(obj).val());
}
var selectedType;
var showCT = function (obj) {
    selectedType = $(obj);
    $(".ctPanel").hide();
    $('.ct' + $(obj).val()).show();
}

var upLoadFile = function () {
    $("#btn-img-change").click();
}
var settingFile = function (file, url) {
    $.ajaxFileUpload({
        url: url, //你处理上传文件的服务端
        secureuri: false,
        fileElementId: 'btn-img-change',
        dataType: 'json',
        data: {uploadtype: 'add'},
        success: function (data)
        {
            if (data.status == 1) {
                url = getObjectURL(file[0]);
                $('.preview').show();
                $('.preview img').attr('src', url);
                $('.type', selectedItem).val('media_id');
                $('.key', selectedItem).val(data.data.fileid);
                $('.media_id', selectedItem).val(data.data.media_id);
                $('.url', selectedItem).val(data.data.url);
                $('.ipt', selectedItem).val(3);
                $('.ipc', selectedItem).val(url);
            }
        }
    })

}
var settingMsg = function (company_id) {
    Wind.use("artDialog", "iframeTools", function () {
        art.dialog.open(GV.ROOT + 'index.php?g=managment&m=autoresponse&a=tuwen&company_id' + company_id, {
            title: '选择图文',
            id: new Date().getTime(),
            width: '650px',
            height: '420px',
            lock: true,
            fixed: true,
            ok: function () {
                var iframewindow = this.iframe.contentWindow;
                var row = iframewindow.getSelect();
                var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + row[0].title + '</div>';
                $('.tw_preview').html(div).show();
                $('.type', selectedItem).val('click');
                $('.key', selectedItem).val('TW_' + row[0].id);
                if (row[0].guide_id > 0)
                    $('.key', selectedItem).val('TW_' + row[0].id + '_G');
                $('.ipt', selectedItem).val(1);
                $('.ipc', selectedItem).val(row[0].title);
            },
            cancel: true
        });
    });
}
var settingKeyWord = function (company_id) {
    Wind.use("artDialog", "iframeTools", function () {
        art.dialog.open(GV.ROOT + 'index.php?g=managment&m=wxPublic&a=key_word&company_id' + company_id, {
            title: '选择关键词',
            id: new Date().getTime(),
            width: '650px',
            height: '420px',
            lock: true,
            fixed: true,
            ok: function () {
                var iframewindow = this.iframe.contentWindow;
                var row = iframewindow.getSelect();
                var div = '<div style="border: 1px solid #ddd;border-radius: 5px;">' + row[0].key + '</div>';
                $('.kw_preview').html(div).show();
                $('.type', selectedItem).val('click');
                $('.key', selectedItem).val('KW_' + row[0].response_id);
                $('.ipt', selectedItem).val(2);
                $('.ipc', selectedItem).val(row[0].key);
            },
            cancel: true
        });
    });
}
var settingContentUrl = function (obj) {
    selectedType.val();
    selectedItem.append()
    $('.url', selectedItem).val($(obj).val());
    $('.type', selectedItem).val('view');
    $('.ipt', selectedItem).val(4);
}
var saveDate = function (url) {
    $.post(url, $(".new").serialize(), function (res) {
        layui.use('layer', function () {
            var layer = layui.layer;
            if (res.status === 1) {
                layer.msg(res.info);
            } else {
                layer.msg(res.info);
            }
        });
    }, 'JSON');
}
var initPage = function () {
    var button = $(".mobile-bd .pre-menu-item").not(".add-item");
    if (button.length >= 3)
        $(".add-item").remove();
    button.each(function () {
        var sub_button = $(".sub-item", this).not(".add-subitem");
        if (sub_button.length >= 5)
            $(".add-subitem", this).remove();
    });
    $(".menu-form-area").hide();
}
var pushMenu = function (url) {
    $.ajax({
        url: url,
        dataType:"json",
        success: function (res) {
            layui.use('layer', function () {
            var layer = layui.layer;
            if (res.errcode === 0) {
                layer.msg('发布成功');
            } else {
                layer.msg(res.errmsg);
            }
        });
        },
        error: function (e) {
            layui.use('layer', function () {
            var layer = layui.layer;
            layer.msg('发布出错了,请检查菜单名称是否超长');
            });
        }
    });
}

var quickUrl = function (baseUrl,obj) {
    var url = $(obj).attr('data-url');
    $(".menu-name").val($(obj).html()).trigger('change');
    $(".url-input").val(baseUrl+url).trigger('change').val('');
    $('.ipt', selectedItem).val(5);
    $(".q-button").removeClass('active');
    $(obj).addClass("active");
}